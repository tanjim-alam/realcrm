<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Lead Capture Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Hero Section -->
    <div class="gradient-bg min-h-screen flex items-center justify-center px-4">
        <div class="max-w-4xl mx-auto text-center text-white">
            <h1 class="text-5xl font-bold mb-6">Find Your Dream Home</h1>
            <p class="text-xl mb-8 opacity-90">Discover premium properties in the best locations with our expert real estate services.</p>
            
            <!-- Lead Capture Form -->
            <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md mx-auto">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Get Started Today</h2>
                
                <form id="leadForm" class="space-y-4">
                    <div>
                        <input 
                            type="text" 
                            id="name" 
                            name="name"
                            placeholder="Full Name" 
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                    
                    <div>
                        <input 
                            type="email" 
                            id="email" 
                            name="email"
                            placeholder="Email Address" 
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                    
                    <div>
                        <input 
                            type="tel" 
                            id="phone" 
                            name="phone"
                            placeholder="Phone Number" 
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                    
                    <div>
                        <select 
                            id="projectName" 
                            name="projectName"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">Select Project</option>
                            <option value="Sobha Properties">Sobha Properties</option>
                            <option value="Sobha Scarlet">Sobha Scarlet</option>
                            <option value="Sobha Neopolis">Sobha Neopolis</option>
                            <option value="Sobha Dream Gardens">Sobha Dream Gardens</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <button 
                        type="submit" 
                        id="submitBtn"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                    >
                        Get Free Consultation
                    </button>
                </form>
                
                <p class="text-sm text-gray-500 mt-4">
                    By submitting this form, you agree to our privacy policy and terms of service.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Replace with your actual values
        const CONFIG = {
            // Email API (your existing)
            smtp_api: "https://email-server-production-891b.up.railway.app/send-email",
            company_email: "info@searchmyspace.in",
            project_name: "Sobha Properties",
            
            // CRM API (new integration)
            crm_api: "http://localhost:8080/api/webhooks/leads",
            companyId: "YOUR_COMPANY_ID_HERE", // Replace with your actual company ID
            apiKey: "YOUR_WEBHOOK_API_KEY_HERE", // Replace with your actual API key
            
            // Country code (if needed)
            country_code: "+91"
        };

        // Phone number validation pattern
        const phoneNumberPattern = /^(\+\d{1,2}\s?)?(\(?\d{3}\)?[\s.-]?)?\d{3}[\s.-]?\d{4}$/;

        // Form validation
        function validateForm(name, email, phone) {
            if (!name || !email || !phone) {
                alert("Please fill in all required fields.");
                return false;
            }
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert("Please enter a valid email address.");
                return false;
            }
            
            return true;
        }

        // Submit to email server (your existing function)
        async function submitForm(name, email, phone, projectName = CONFIG.project_name, countryCode = CONFIG.country_code) {
            const data = {
                name,
                email,
                number: phone,
                country_code: countryCode,
                company_email: CONFIG.company_email,
                project_name: projectName
            };

            try {
                const res = await fetch(CONFIG.smtp_api, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    const responseData = await res.json();
                    console.log("Email sent successfully:", responseData.message);
                    return true;
                } else {
                    console.error("Email sending failed");
                    return false;
                }
            } catch (error) {
                console.error("Email error:", error.message);
                return false;
            }
        }

        // Submit to CRM (simplified function)
        async function submitToCRM(name, email, phone, projectName, source = "website") {
            const crmData = {
                name: name,
                email: email,
                phone: phone,
                companyId: CONFIG.companyId,
                source: source,
                projectName: projectName,
                apiKey: CONFIG.apiKey
            };

            try {
                const response = await fetch(CONFIG.crm_api, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(crmData)
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log("Lead saved to CRM successfully:", result.leadId);
                    return true;
                } else {
                    console.error("CRM error:", result.message);
                    return false;
                }
            } catch (error) {
                console.error("CRM error:", error);
                return false;
            }
        }

        // Main form submission handler
        document.getElementById('leadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.textContent = 'Submitting...';
            submitBtn.disabled = true;
            
            try {
                // Collect form data
                const formData = {
                    name: document.getElementById('name').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    projectName: document.getElementById('projectName').value || "Sobha Properties"
                };

                // Validate form
                if (!validateForm(formData.name, formData.email, formData.phone)) {
                    return;
                }

                // Submit to both email and CRM
                const [emailSuccess, crmSuccess] = await Promise.allSettled([
                    submitForm(formData.name, formData.email, formData.phone, formData.projectName),
                    submitToCRM(formData.name, formData.email, formData.phone, formData.projectName, "website")
                ]);

                // Check results
                const emailSent = emailSuccess.status === 'fulfilled' && emailSuccess.value;
                const crmSaved = crmSuccess.status === 'fulfilled' && crmSuccess.value;

                if (emailSent && crmSaved) {
                    // Both successful
                    alert('Thank you! We have received your information and will contact you soon.');
                    document.getElementById('leadForm').reset();
                } else if (emailSent || crmSaved) {
                    // At least one successful
                    alert('Thank you! We have received your information and will contact you soon.');
                    document.getElementById('leadForm').reset();
                } else {
                    // Both failed
                    alert('Something went wrong. Please try again or contact us directly.');
                }

            } catch (error) {
                console.error('Submission error:', error);
                alert('Something went wrong. Please try again.');
            } finally {
                // Reset button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Optional: Add real-time validation
        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (email && !emailRegex.test(email)) {
                this.style.borderColor = '#ef4444';
                this.style.backgroundColor = '#fef2f2';
            } else {
                this.style.borderColor = '#d1d5db';
                this.style.backgroundColor = '#ffffff';
            }
        });

        // Optional: Format phone number
        document.getElementById('phone').addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 3) {
                    value = value;
                } else if (value.length <= 6) {
                    value = value.slice(0, 3) + '-' + value.slice(3);
                } else {
                    value = value.slice(0, 3) + '-' + value.slice(3, 6) + '-' + value.slice(6, 10);
                }
            }
            this.value = value;
        });
    </script>
</body>
</html>